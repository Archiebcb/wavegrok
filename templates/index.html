<script>
    let symbols = [];
    fetch('/symbols')
        .then(response => response.json())
        .then(data => symbols = data.symbols || [])
        .catch(error => console.error('Error fetching symbols:', error));

    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    themeToggle.addEventListener('click', () => {
        if (body.classList.contains('dark-theme')) {
            body.classList.remove('dark-theme');
            body.classList.add('light-theme');
            themeToggle.textContent = 'Switch to Dark Mode';
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.remove('light-theme');
            body.classList.add('dark-theme');
            themeToggle.textContent = 'Switch to Light Mode';
            localStorage.setItem('theme', 'dark');
        }
    });

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        body.classList.remove('dark-theme');
        body.classList.add('light-theme');
        themeToggle.textContent = 'Switch to Dark Mode';
    }

    document.getElementById('fetchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.indicators = formData.getAll('indicators');
        const messageDiv = document.getElementById('message');
        const analysisDiv = document.getElementById('analysis');
        const sentimentDiv = document.getElementById('sentimentValue');
        const loadingDiv = document.getElementById('loading');
        messageDiv.textContent = 'Fetching data...';
        loadingDiv.classList.remove('hidden');

        try {
            const fetchResponse = await fetch('/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const fetchResult = await fetchResponse.json();
            messageDiv.textContent = fetchResult.message;

            if (fetchResult.message.includes('Fetched') || fetchResult.message.includes('Loaded')) {
                const chartImg = document.getElementById('chart');
                chartImg.src = `/chart/${data.timeframe}?indicators=${data.indicators.join(',')}&t=${new Date().getTime()}`;

                const analyzeResponse = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: data.symbol, primary_tf: data.timeframe, secondary_tf: data.timeframe })
                });
                const analyzeResult = await analyzeResponse.json();
                analysisDiv.textContent = analyzeResult.message;

                const sentimentResponse = await fetch(`/sentiment/${data.symbol}`);
                const sentimentResult = await sentimentResponse.json();
                sentimentDiv.textContent = sentimentResult.sentiment ? `${sentimentResult.sentiment} (${sentimentResult.score.toFixed(2)})` : 'N/A';
            }
        } catch (error) {
            messageDiv.textContent = 'Error: ' + error.message;
            analysisDiv.textContent = '';
            sentimentDiv.textContent = 'N/A';
        } finally {
            loadingDiv.classList.add('hidden');
        }
    });

    document.querySelectorAll('input[name="indicators"]').forEach(checkbox => {
        checkbox.addEventListener('change', async () => {
            const formData = new FormData(document.getElementById('fetchForm'));
            const data = Object.fromEntries(formData);
            data.indicators = formData.getAll('indicators');
            const chartImg = document.getElementById('chart');
            chartImg.src = `/chart/${data.timeframe}?indicators=${data.indicators.join(',')}&t=${new Date().getTime()}`;
        });
    });

    setInterval(async () => {
        let symbol = document.getElementById('symbol').value.replace('/', ''); // Remove slashes
        if (symbol) {
            let attempts = 0;
            const maxAttempts = 3;
            while (attempts < maxAttempts) {
                try {
                    const priceResponse = await fetch(`/price/${symbol}`);
                    if (!priceResponse.ok) throw new Error(`HTTP error! status: ${priceResponse.status}`);
                    const priceResult = await priceResponse.json();
                    document.getElementById('priceValue').textContent = priceResult.price ? `$${priceResult.price.toFixed(2)}` : 'N/A';

                    const sentimentResponse = await fetch(`/sentiment/${symbol}`);
                    if (!sentimentResponse.ok) throw new Error(`HTTP error! status: ${sentimentResponse.status}`);
                    const sentimentResult = await sentimentResponse.json();
                    document.getElementById('sentimentValue').textContent = sentimentResult.sentiment ? `${sentimentResult.sentiment} (${sentimentResult.score.toFixed(2)})` : 'N/A';
                    break;
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed: ${error.message}`);
                    if (attempts === maxAttempts) {
                        document.getElementById('priceValue').textContent = 'N/A';
                        document.getElementById('sentimentValue').textContent = 'N/A';
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
        }
    }, 10000);

    setInterval(async () => {
        const formData = new FormData(document.getElementById('fetchForm'));
        const data = Object.fromEntries(formData);
        data.indicators = formData.getAll('indicators');
        if (data.symbol && data.timeframe && data.limit) {
            await fetch('/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const chartImg = document.getElementById('chart');
            chartImg.src = `/chart/${data.timeframe}?indicators=${data.indicators.join(',')}&t=${new Date().getTime()}`;
        }
    }, 60000);

    const symbolInput = document.getElementById('symbol');
    const suggestionsDiv = document.getElementById('suggestions');
    symbolInput.addEventListener('input', () => {
        let query = symbolInput.value.toUpperCase().replace('/', ''); // Remove slashes from input
        if (query.length < 2) {
            suggestionsDiv.classList.add('hidden');
            return;
        }
        const matches = symbols.filter(s => s.toUpperCase().includes(query)).slice(0, 10);
        if (matches.length === 0) {
            suggestionsDiv.classList.add('hidden');
            return;
        }
        suggestionsDiv.innerHTML = matches.map(s => `<div class="p-2 hover:bg-gray-600 cursor-pointer">${s}</div>`).join('');
        suggestionsDiv.classList.remove('hidden');
        suggestionsDiv.querySelectorAll('div').forEach(item => {
            item.addEventListener('click', () => {
                symbolInput.value = item.textContent;
                suggestionsDiv.classList.add('hidden');
            });
        });
    });
    symbolInput.addEventListener('focus', () => {
        if (symbolInput.value.length >= 2) suggestionsDiv.classList.remove('hidden');
    });
    symbolInput.addEventListener('blur', () => setTimeout(() => suggestionsDiv.classList.add('hidden'), 200));

    document.getElementById('download').addEventListener('click', () => {
        const chartImg = document.getElementById('chart');
        const link = document.createElement('a');
        link.href = chartImg.src;
        link.download = `wavegrok_chart_${new Date().toISOString()}.png`;
        link.click();
    });
</script>